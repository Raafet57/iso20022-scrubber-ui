<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Storyteller – ISO 20022 Narrative Generator</title>
    <style>
      :root {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background-color: #f5f6fb;
        color: #111827;
      }
      body {
        margin: 0;
        padding: 2rem;
      }
      .page {
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 {
        margin-bottom: 0.5rem;
      }
      p {
        color: #4b5563;
      }
      .layout {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
      }
      .card {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 20px 45px rgba(15, 23, 42, 0.12);
        padding: 1.5rem;
      }
      textarea {
        width: 100%;
        min-height: 260px;
        font-family: 'JetBrains Mono', 'SFMono-Regular', Consolas, monospace;
        font-size: 0.95rem;
        border-radius: 14px;
        border: 1px solid #d1d5db;
        padding: 0.9rem;
        resize: vertical;
        background: #f9fafb;
      }
      textarea:focus,
      input:focus,
      select:focus {
        outline: 2px solid #2563eb;
        border-color: transparent;
        background: #fff;
      }
      label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: #374151;
      }
      select,
      input[type="file"] {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        background: #fff;
      }
      .controls {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 1rem;
      }
      .btn {
        border: none;
        border-radius: 999px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: box-shadow 150ms ease, transform 150ms ease;
      }
      .btn-primary {
        background: linear-gradient(135deg, #2563eb, #7c3aed);
        color: #fff;
        box-shadow: 0 20px 40px rgba(37, 99, 235, 0.35);
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 25px 60px rgba(37, 99, 235, 0.45);
      }
      .btn-secondary {
        background: #eef2ff;
        color: #312e81;
      }
      .actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .tabs {
        display: flex;
        gap: 0.5rem;
        margin: 1rem 0;
      }
      .tab-button {
        border: none;
        border-radius: 999px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        background: #e5e7eb;
      }
      .tab-button.active {
        background: #1d4ed8;
        color: #fff;
      }
      pre {
        background: #0f172a;
        color: #e2e8f0;
        border-radius: 12px;
        padding: 1rem;
        max-height: 320px;
        overflow: auto;
        font-size: 0.9rem;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.75rem;
        margin-bottom: 1rem;
      }
      .stat-card {
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 0.75rem;
        background: #f9fafb;
      }
      .stat-card .label {
        font-size: 0.8rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .stat-card .value {
        font-size: 1.2rem;
        font-weight: 700;
        margin-top: 0.2rem;
      }
      .alert {
        background: #fee2e2;
        color: #b91c1c;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        margin-top: 1rem;
      }
      .summary-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        font-size: 0.9rem;
      }
      .summary-table th,
      .summary-table td {
        padding: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
      }
      .summary-table th {
        color: #6b7280;
        font-weight: 600;
      }
      .hidden {
        display: none;
      }
      @media (max-width: 640px) {
        body {
          padding: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <h1>Storyteller</h1>
        <p>
          ISO 20022 narrative generator (pacs.008 / pacs.009 / camt.053). Paste XML or load a sample to produce
          both paragraph and concise summaries.
        </p>
      </header>

      <section class="layout">
        <div class="card">
          <label for="xmlInput">Payment XML</label>
          <textarea id="xmlInput" placeholder="Paste ISO 20022 XML here..."></textarea>
          <div class="controls">
            <div>
              <label for="sampleSelect">Load sample</label>
              <select id="sampleSelect">
                <option value="">Select sample...</option>
                <option value="../samples/pacs008-sample.xml">pacs.008 – cover payment</option>
                <option value="../samples/pacs009-sample.xml">pacs.009 – CPPC route</option>
                <option value="../samples/camt053-sample.xml">camt.053 – multi-entry statement</option>
              </select>
            </div>
            <div>
              <label for="fileInput">Upload XML file</label>
              <input type="file" id="fileInput" accept=".xml,text/xml" />
            </div>
            <button class="btn btn-primary" id="summarizeButton">Generate narrative</button>
            <div id="inputError" class="alert hidden"></div>
          </div>
        </div>

        <div class="card">
          <div style="display: flex; justify-content: space-between; gap: 1rem; flex-wrap: wrap">
            <div>
              <h2 style="margin: 0">Narratives</h2>
              <p style="margin: 0">
                Select narrative or concise mode; view parsed data below.
              </p>
            </div>
            <div class="actions">
              <button class="btn btn-secondary" id="copyNarrative" disabled>Copy narrative</button>
              <button class="btn btn-secondary" id="copyConcise" disabled>Copy concise</button>
            </div>
          </div>
          <div id="loader" class="alert hidden">Processing...</div>
          <div id="resultsEmpty" style="margin-top: 1rem; color: #6b7280">
            Paste XML or load a sample to generate narratives.
          </div>
          <div id="resultsContainer" class="hidden">
            <div class="tabs">
              <button class="tab-button active" data-tab="narrative">Narrative</button>
              <button class="tab-button" data-tab="concise">Concise</button>
              <button class="tab-button" data-tab="data">Data</button>
            </div>
            <div id="tab-narrative">
              <pre id="narrativeOutput"></pre>
            </div>
            <div id="tab-concise" class="hidden">
              <pre id="conciseOutput"></pre>
            </div>
            <div id="tab-data" class="hidden">
              <table class="summary-table" id="summaryTable"></table>
              <pre id="jsonOutput"></pre>
            </div>
          </div>
        </div>
      </section>
    </div>

    <script>
      const textarea = document.getElementById('xmlInput');
      const sampleSelect = document.getElementById('sampleSelect');
      const fileInput = document.getElementById('fileInput');
      const button = document.getElementById('summarizeButton');
      const loader = document.getElementById('loader');
      const resultsContainer = document.getElementById('resultsContainer');
      const resultsEmpty = document.getElementById('resultsEmpty');
      const narrativeOutput = document.getElementById('narrativeOutput');
      const conciseOutput = document.getElementById('conciseOutput');
      const jsonOutput = document.getElementById('jsonOutput');
      const summaryTable = document.getElementById('summaryTable');
      const inputError = document.getElementById('inputError');
      const copyNarrative = document.getElementById('copyNarrative');
      const copyConcise = document.getElementById('copyConcise');

      const tabs = document.querySelectorAll('.tab-button');
      tabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          tabs.forEach((btn) => btn.classList.remove('active'));
          tab.classList.add('active');
          ['narrative', 'concise', 'data'].forEach((key) => {
            document.getElementById(`tab-${key}`).classList.add('hidden');
          });
          document.getElementById(`tab-${tab.dataset.tab}`).classList.remove('hidden');
        });
      });

      const INLINE_SAMPLES = {
        '../samples/pacs008-sample.xml': `<?xml version="1.0" encoding="UTF-8"?>
<Document xmlns="urn:iso:std:iso:20022:tech:xsd:pacs.008.001.08">
  <FIToFICstmrCdtTrf>
    <GrpHdr>
      <MsgId>COVER-DBCC-USD-20250301</MsgId>
      <CreDtTm>2025-03-01T09:15:00-05:00</CreDtTm>
      <NbOfTxs>1</NbOfTxs>
      <SttlmInf>
        <SttlmMtd>COVE</SttlmMtd>
      </SttlmInf>
    </GrpHdr>
    <CdtTrfTxInf>
      <PmtId>
        <InstrId>DBCC-OUR-77811</InstrId>
        <EndToEndId>ACME-COVER-PO-77811</EndToEndId>
        <TxId>BDCCBQBN-2025-COVER</TxId>
        <UETR>f1d2f3a4-1111-4c5d-bbed-f5791b1f4412</UETR>
      </PmtId>
      <IntrBkSttlmAmt Ccy="USD">125000.00</IntrBkSttlmAmt>
      <ChrgBr>OUR</ChrgBr>
      <UltmtDbtr>
        <Nm>ACME HOLDINGS LLC</Nm>
      </UltmtDbtr>
      <Dbtr>
        <Nm>BANCO DI CARIBE N.V. BONAIRE</Nm>
        <PstlAdr>
          <StrtNm>KAYA GRANDI 22</StrtNm>
          <TwnNm>KRALENDIJK</TwnNm>
          <Ctry>BQ</Ctry>
          <PstCd>00000</PstCd>
        </PstlAdr>
      </Dbtr>
      <DbtrAcct>
        <Id>
          <IBAN>BQ20BDCC12345678901234</IBAN>
        </Id>
      </DbtrAcct>
      <DbtrAgt>
        <FinInstnId>
          <BICFI>BDCCBQBNXXX</BICFI>
        </FinInstnId>
      </DbtrAgt>
      <IntrmyAgt1>
        <FinInstnId>
          <BICFI>BKTRUS33XXX</BICFI>
          <Nm>THE BANK OF NEW YORK MELLON</Nm>
        </FinInstnId>
      </IntrmyAgt1>
      <CdtrAgt>
        <FinInstnId>
          <BICFI>HMBKUS44GAR</BICFI>
        </FinInstnId>
      </CdtrAgt>
      <Cdtr>
        <Nm>HARMONY BANK GARLAND</Nm>
        <PstlAdr>
          <StrtNm>515 WEST AVENUE</StrtNm>
          <TwnNm>GARLAND</TwnNm>
          <Ctry>US</Ctry>
          <PstCd>75042</PstCd>
        </PstlAdr>
      </Cdtr>
      <CdtrAcct>
        <Id>
          <IBAN>US12HMBK11192511300001</IBAN>
        </Id>
      </CdtrAcct>
      <RmtInf>
        <Ustrd>Cover payment for invoice set GAR-2025-03</Ustrd>
      </RmtInf>
    </CdtTrfTxInf>
  </FIToFICstmrCdtTrf>
</Document>`,
        '../samples/pacs009-sample.xml': `<?xml version="1.0" encoding="UTF-8"?>
<Document xmlns="urn:iso:std:iso:20022:tech:xsd:pacs.009.001.08">
  <FICdtTrf>
    <GrpHdr>
      <MsgId>PNB-COVER-20250311</MsgId>
      <CreDtTm>2025-03-11T07:30:00+05:30</CreDtTm>
      <NbOfTxs>1</NbOfTxs>
      <TtlIntrBkSttlmAmt Ccy="INR">450000000</TtlIntrBkSttlmAmt>
      <SttlmInf>
        <SttlmMtd>COVE</SttlmMtd>
      </SttlmInf>
    </GrpHdr>
    <CdtTrfTxInf>
      <PmtId>
        <InstrId>PNB-CPPC-JPR-458</InstrId>
        <EndToEndId>CPPC-RET-458</EndToEndId>
        <TxId>PUNB0746500-2025-458</TxId>
        <UETR>1d1d67e3-30b2-44fb-8d6a-7cfc8654d0e6</UETR>
      </PmtId>
      <IntrBkSttlmAmt Ccy="INR">450000000</IntrBkSttlmAmt>
      <ChrgBr>SHA</ChrgBr>
      <DbtrAgt>
        <FinInstnId>
          <BICFI>PUNBINBBXXX</BICFI>
        </FinInstnId>
      </DbtrAgt>
      <IntermediaryAgt1>
        <FinInstnId>
          <BICFI>PUNB0746500</BICFI>
          <Nm>PUNJAB NATIONAL BANK CPPC JAIPUR</Nm>
        </FinInstnId>
      </IntermediaryAgt1>
      <IntermediaryAgt2>
        <FinInstnId>
          <BICFI>PUNB0747000</BICFI>
          <Nm>PUNJAB NATIONAL BANK CPPC KOLKATA</Nm>
        </FinInstnId>
      </IntermediaryAgt2>
      <CdtrAgt>
        <FinInstnId>
          <BICFI>IDIBINBBLAL</BICFI>
        </FinInstnId>
      </CdtrAgt>
      <Cdtr>
        <Nm>ICICI BANK LTD PANJRAPOLE</Nm>
        <PstlAdr>
          <StrtNm>SHIVALIK SHARDA HARMONY</StrtNm>
          <TwnNm>AHMEDABAD</TwnNm>
          <Ctry>IN</Ctry>
          <PstCd>380015</PstCd>
        </PstlAdr>
      </Cdtr>
      <CdtrAcct>
        <Id>
          <IBAN>IN98ICIC00083660004567890</IBAN>
        </Id>
      </CdtrAcct>
      <RmtInf>
        <Ustrd>Corporate pension reimbursement</Ustrd>
      </RmtInf>
    </CdtTrfTxInf>
  </FICdtTrf>
</Document>`,
        '../samples/camt053-sample.xml': `<?xml version="1.0" encoding="UTF-8"?>
<Document xmlns="urn:iso:std:iso:20022:tech:xsd:camt.053.001.10">
  <BkToCstmrStmt>
    <GrpHdr>
      <MsgId>MULTI-ENTRY-20250315</MsgId>
      <CreDtTm>2025-03-15T05:40:00Z</CreDtTm>
    </GrpHdr>
    <Stmt>
      <Id>HARMONY-DAILY-2025-03-15</Id>
      <ElctrncSeqNb>88</ElctrncSeqNb>
      <CreDtTm>2025-03-15T05:30:00Z</CreDtTm>
      <Acct>
        <Id>
          <IBAN>US98HMBK09120446200111</IBAN>
        </Id>
        <Ownr>
          <Nm>FIRST SOUTHEAST BANK HARMONY</Nm>
        </Ownr>
        <Svcr>
          <FinInstnId>
            <BICFI>HMBKUS44GAR</BICFI>
          </FinInstnId>
        </Svcr>
      </Acct>
      <Bal>
        <Tp>
          <CdOrPrtry>
            <Cd>CLBD</Cd>
          </CdOrPrtry>
        </Tp>
        <Amt Ccy="USD">2150000.00</Amt>
        <CdtDbtInd>CRDT</CdtDbtInd>
        <Dt>
          <Dt>2025-03-14</Dt>
        </Dt>
      </Bal>
      <Ntry>
        <Amt Ccy="USD">-250000.00</Amt>
        <CdtDbtInd>DBIT</CdtDbtInd>
        <BookgDt>
          <Dt>2025-03-14</Dt>
        </BookgDt>
        <ValDt>
          <Dt>2025-03-14</Dt>
        </ValDt>
        <AcctSvcrRef>HMBK-REF-991</AcctSvcrRef>
        <NtryDtls>
          <TxDtls>
            <Refs>
              <EndToEndId>GARLAND-PAYROLL-MAR</EndToEndId>
              <TxId>HMBKUS44GAR-991</TxId>
            </Refs>
            <RltdPties>
              <Cdtr>
                <Nm>HARMONY PAYROLL SERVICES</Nm>
              </Cdtr>
            </RltdPties>
            <RmtInf>
              <Ustrd>Payroll batch March</Ustrd>
            </RmtInf>
          </TxDtls>
        </NtryDtls>
      </Ntry>
      <Ntry>
        <Amt Ccy="USD">+125000.00</Amt>
        <CdtDbtInd>CRDT</CdtDbtInd>
        <BookgDt>
          <Dt>2025-03-14</Dt>
        </BookgDt>
        <ValDt>
          <Dt>2025-03-14</Dt>
        </ValDt>
        <AcctSvcrRef>HMBK-REF-992</AcctSvcrRef>
        <NtryDtls>
          <TxDtls>
            <Refs>
              <EndToEndId>CLIENT-FEE-145</EndToEndId>
              <TxId>HMBKUS44GAR-992</TxId>
            </Refs>
            <RltdPties>
              <Dbtr>
                <Nm>ACME CONSULTING</Nm>
              </Dbtr>
            </RltdPties>
            <RmtInf>
              <Ustrd>Consulting fees</Ustrd>
            </RmtInf>
          </TxDtls>
        </NtryDtls>
      </Ntry>
      <Ntry>
        <Amt Ccy="USD">-17500.50</Amt>
        <CdtDbtInd>DBIT</CdtDbtInd>
        <BookgDt>
          <Dt>2025-03-14</Dt>
        </BookgDt>
        <ValDt>
          <Dt>2025-03-14</Dt>
        </ValDt>
        <AcctSvcrRef>HMBK-REF-993</AcctSvcrRef>
        <NtryDtls>
          <TxDtls>
            <Refs>
              <EndToEndId>UTILITY-294</EndToEndId>
            </Refs>
            <RmtInf>
              <Ustrd>Utility settlement</Ustrd>
            </RmtInf>
          </TxDtls>
        </NtryDtls>
      </Ntry>
    </Stmt>
  </BkToCstmrStmt>
</Document>`,
      };

      sampleSelect.addEventListener('change', async (event) => {
        const path = event.target.value;
        if (!path) return;
        if (INLINE_SAMPLES[path]) {
          textarea.value = INLINE_SAMPLES[path];
          inputError.classList.add('hidden');
          return;
        }
        loader.classList.remove('hidden');
        try {
          const response = await fetch(path);
          textarea.value = await response.text();
          inputError.classList.add('hidden');
        } catch (err) {
          inputError.textContent = 'Unable to load sample file via browser fetch. Serve the UI via http.server or upload the XML manually.';
          inputError.classList.remove('hidden');
        } finally {
          loader.classList.add('hidden');
        }
      });

      fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          textarea.value = reader.result;
        };
        reader.readAsText(file);
      });

      copyNarrative.addEventListener('click', () => {
        navigator.clipboard.writeText(narrativeOutput.textContent);
        copyNarrative.textContent = 'Copied';
        setTimeout(() => (copyNarrative.textContent = 'Copy narrative'), 1500);
      });
      copyConcise.addEventListener('click', () => {
        navigator.clipboard.writeText(conciseOutput.textContent);
        copyConcise.textContent = 'Copied';
        setTimeout(() => (copyConcise.textContent = 'Copy concise'), 1500);
      });

      button.addEventListener('click', () => {
        const xml = textarea.value.trim();
        if (!xml) {
          inputError.textContent = 'Paste ISO 20022 XML or load a sample.';
          inputError.classList.remove('hidden');
          return;
        }
        inputError.classList.add('hidden');
        loader.classList.remove('hidden');
        setTimeout(() => {
          try {
            const payload = parseMessage(xml);
            const narrative = generateNarrative(payload, 'narrative');
            const concise = generateNarrative(payload, 'concise');
            renderResults(payload, narrative, concise);
          } catch (err) {
            inputError.textContent = err.message;
            inputError.classList.remove('hidden');
            resultsContainer.classList.add('hidden');
            resultsEmpty.classList.remove('hidden');
          } finally {
            loader.classList.add('hidden');
          }
        }, 50);
      });

      function parseMessage(xmlText) {
        const doc = new DOMParser().parseFromString(xmlText, 'text/xml');
        const root = doc.documentElement;
        if (!root || !root.children.length) {
          throw new Error('Invalid ISO 20022 payload.');
        }
        const documentNode = root.children[0];
        const type = documentNode.localName;
        if (type === 'FIToFICstmrCdtTrf') return extractPacs008(documentNode);
        if (type === 'FICdtTrf') return extractPacs009(documentNode);
        if (type === 'BkToCstmrStmt') return extractCamt053(documentNode);
        throw new Error(`Unsupported ISO 20022 message: ${type}`);
      }

      const child = (node, name) => {
        if (!node) return null;
        return Array.from(node.children).find((c) => c.localName === name) || null;
      };
      const children = (node, name) => {
        if (!node) return [];
        return Array.from(node.children).filter((c) => c.localName === name);
      };

      const text = (node) => (node && node.textContent ? node.textContent.trim() : '');

      const actor = (node) => {
        if (!node) return null;
        const addr = child(node, 'PstlAdr');
        const parts = addr
          ? Array.from(addr.children).map((c) => text(c)).filter(Boolean)
          : [];
        let name = text(child(node, 'Nm'));
        if (!name) {
          const bic = child(child(node, 'FinInstnId'), 'BICFI');
          name = text(bic);
        }
        return {
          name: name || null,
          address: parts.length ? parts.join(', ') : null,
        };
      };

      function extractPacs008(doc) {
        const grpHdr = child(doc, 'GrpHdr');
        const tx = child(doc, 'CdtTrfTxInf');
        if (!tx) throw new Error('pacs.008 missing transaction information.');
        const pmtId = child(tx, 'PmtId');
        const timeline = {
          created: text(child(grpHdr, 'CreDtTm')),
          requested_execution: text(child(child(child(tx, 'PmtTpInf'), 'SvcLvl'), 'ReqdExctnDt')) || text(child(child(tx, 'PmtTpInf'), 'ReqdExctnDt')),
          settlement: text(child(tx, 'SttlmDt')),
        };
        const rem = child(tx, 'RmtInf');
        const unstructured = rem
          ? children(rem, 'Ustrd').map((node) => text(node)).filter(Boolean)
          : [];
        const structured = rem
          ? children(rem, 'Strd')
              .map((node) => text(child(child(node, 'CdtrRefInf'), 'Ref')))
              .filter(Boolean)
          : [];
        const intermediaries = [];
        for (let i = 1; i <= 3; i += 1) {
          const agent = child(tx, `IntrmyAgt${i}`);
          const bic = text(child(child(agent, 'FinInstnId'), 'BICFI'));
          if (bic) intermediaries.push(bic);
        }
        const debtorAgent = child(tx, 'DbtrAgt');
        const creditorAgent = child(tx, 'CdtrAgt');
        const debtorAgentBic = text(child(child(debtorAgent, 'FinInstnId'), 'BICFI'));
        const creditorAgentBic = text(child(child(creditorAgent, 'FinInstnId'), 'BICFI'));
        return {
          message_type: 'pacs.008',
          actors: {
            debtor: actor(child(tx, 'Dbtr')),
            ultimate_debtor: actor(child(tx, 'UltmtDbtr')),
            creditor: actor(child(tx, 'Cdtr')),
            ultimate_creditor: actor(child(tx, 'UltmtCdtr')),
          },
          financial: {
            settlement_amount: amountNode(child(tx, 'IntrBkSttlmAmt')),
            instructed_amount: amountNode(child(tx, 'InstdAmt')),
            charge_bearer: text(child(tx, 'ChrgBr')) || 'unspecified',
          },
          timeline,
          references: {
            instruction: text(child(pmtId, 'InstrId')),
            end_to_end: text(child(pmtId, 'EndToEndId')),
            transaction: text(child(pmtId, 'TxId')),
            uetr: text(child(pmtId, 'UETR')),
          },
          remittance: {
            unstructured,
            structured,
          },
          route: {
            debtor_agent: debtorAgentBic || text(child(debtorAgent, 'FinInstnId')),
            creditor_agent: creditorAgentBic || text(child(creditorAgent, 'FinInstnId')),
            intermediaries,
          },
        };
      }

      function extractPacs009(doc) {
        const grpHdr = child(doc, 'GrpHdr');
        const tx = child(doc, 'CdtTrfTxInf');
        if (!tx) throw new Error('pacs.009 missing transaction information.');
        const pmtId = child(tx, 'PmtId');
        const intermediaries = [];
        for (let i = 1; i <= 3; i += 1) {
          const agt = child(tx, `IntermediaryAgt${i}`);
          const bic = text(child(child(agt, 'FinInstnId'), 'BICFI'));
          if (bic) intermediaries.push(bic);
        }
        return {
          message_type: 'pacs.009',
          actors: {
            debtor_agent: actor(child(tx, 'DbtrAgt')),
            creditor_agent: actor(child(tx, 'CdtrAgt')),
            creditor: actor(child(tx, 'Cdtr')),
          },
          financial: {
            settlement_amount: amountNode(child(grpHdr, 'TtlIntrBkSttlmAmt')),
            charge_bearer: text(child(tx, 'ChrgBr')) || 'unspecified',
          },
          timeline: {
            created: text(child(grpHdr, 'CreDtTm')),
            settlement: text(child(child(grpHdr, 'SttlmInf'), 'SttlmDt')),
          },
          references: {
            instruction: text(child(pmtId, 'InstrId')),
            end_to_end: text(child(pmtId, 'EndToEndId')),
            transaction: text(child(pmtId, 'TxId')),
            uetr: text(child(pmtId, 'UETR')),
          },
          remittance: {
            unstructured: children(child(tx, 'RmtInf'), 'Ustrd').map((node) => text(node)).filter(Boolean),
          },
          route: { intermediaries },
        };
      }

      function extractCamt053(doc) {
        const stmt = child(doc, 'Stmt');
        if (!stmt) throw new Error('camt.053 missing statement block.');
        const entries = children(stmt, 'Ntry').map((entry) => ({
          amount: text(child(entry, 'Amt')),
          currency: attr(child(entry, 'Amt'), 'Ccy'),
          credit_debit: text(child(entry, 'CdtDbtInd')),
          booking_date: text(child(child(entry, 'BookgDt'), 'Dt')),
          value_date: text(child(child(entry, 'ValDt'), 'Dt')),
          reference: text(child(entry, 'AcctSvcrRef')),
          remittance: text(child(child(child(entry, 'NtryDtls'), 'TxDtls'), 'RmtInf') && child(child(child(entry, 'NtryDtls'), 'TxDtls'), 'RmtInf').children.length ? text(child(child(child(entry, 'NtryDtls'), 'TxDtls'), 'RmtInf').children[0]) : '',
        }));
        const acct = child(stmt, 'Acct');
        const bal = child(stmt, 'Bal');
        const closingAmtNode = child(bal, 'Amt');
        return {
          message_type: 'camt.053',
          statement_id: text(child(stmt, 'Id')),
          generated_at: text(child(stmt, 'CreDtTm')),
          account: {
            iban: text(child(child(acct, 'Id'), 'IBAN')),
            owner: actor(child(acct, 'Ownr')),
          },
          closing_balance: {
            amount: text(closingAmtNode),
            currency: attr(closingAmtNode, 'Ccy'),
            date: text(child(child(bal, 'Dt'), 'Dt')),
          },
          entries,
        };
      }

      function amountNode(node) {
        if (!node) return { value: '', currency: null };
        return {
          value: text(node),
          currency: attr(node, 'Ccy') || null,
        };
      }

      function attr(node, name) {
        return node ? node.getAttribute(name) || '' : '';
      }

      function formatAmount(node) {
        if (!node || !node.value) return 'an unspecified amount';
        let formatted = node.value;
        const numeric = Number(node.value.replace(/,/g, ''));
        if (!Number.isNaN(numeric)) {
          formatted = numeric.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        return node.currency ? `${formatted} ${node.currency}` : formatted;
      }

      const actorName = (actorObj) => (actorObj && actorObj.name ? actorObj.name : 'an unspecified party');

      function generateNarrative(payload, mode) {
        if (payload.message_type === 'camt.053') {
          return statementNarrative(payload, mode);
        }
        return paymentNarrative(payload, mode);
      }

      function paymentNarrative(payload, mode) {
        const actors = payload.actors || {};
        const financial = payload.financial || {};
        const timeline = payload.timeline || {};
        const references = payload.references || {};
        const remittance = payload.remittance || {};
        const route = payload.route || {};

        const payer = actorName(actors.debtor || actors.debtor_agent);
        const beneficiary = actorName(actors.creditor);
        const amount = formatAmount(financial.settlement_amount);
        const charge = financial.charge_bearer || 'unspecified';
        const created = timeline.created || timeline.requested_execution || 'n/a';
        const uetr = references.uetr || 'n/a';
        const purpose = remittance.unstructured && remittance.unstructured.length
          ? remittance.unstructured.join('; ')
          : remittance.structured && remittance.structured.length
            ? remittance.structured.join('; ')
            : 'no remittance information';
        const intermediaries = route.intermediaries && route.intermediaries.length
          ? route.intermediaries.join(', ')
          : 'none';

        if (mode === 'concise') {
          return [
            `Payer: ${payer}`,
            `Beneficiary: ${beneficiary}`,
            `Amount: ${amount}`,
            `Charge bearer: ${charge}`,
            `Created: ${created}`,
            `UETR: ${uetr}`,
            `Purpose: ${purpose}`,
            `Intermediaries: ${intermediaries}`,
          ].map((line) => `- ${line}`).join('\n');
        }

        let textBlock = `${payer} is sending ${amount} to ${beneficiary}. `;
        textBlock += `The request was created on ${created}, with charge bearer set to ${charge}. `;
        textBlock += `Routing involves ${intermediaries}. `;
        textBlock += `Purpose: ${purpose}. `;
        if (references.uetr) {
          textBlock += `The transaction UETR is ${references.uetr}.`;
        }
        return textBlock.trim();
      }

      function statementNarrative(payload, mode) {
        const account = payload.account || {};
        const closing = payload.closing_balance || {};
        const entries = payload.entries || [];
        const owner = actorName(account.owner);
        const iban = account.iban || 'unspecified account';
        const amount = closing.amount ? `${Number(closing.amount).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${closing.currency || ''}`.trim() : 'unspecified balance';
        const date = closing.date || payload.generated_at || 'n/a';

        if (mode === 'concise') {
          return [
            `Account owner: ${owner}`,
            `IBAN: ${iban}`,
            `Closing balance: ${amount} on ${date}`,
            `Entries: ${entries.length}`,
          ].map((line) => `- ${line}`).join('\n');
        }

        const samples = entries.slice(0, 3).map((entry) => {
          const entryAmount = entry.amount && entry.currency ? `${entry.amount} ${entry.currency}` : entry.amount || 'n/a';
          return `${entry.credit_debit} entry of ${entryAmount} on ${entry.booking_date} (ref ${entry.reference || 'n/a'})`;
        });
        const sampleText = samples.length ? samples.join('; ') : 'no booked entries described';
        return `Statement for ${owner} (${iban}) reports a closing balance of ${amount} on ${date}. The file lists ${entries.length} entries; examples include ${sampleText}.`;
      }

      function renderResults(payload, narrative, concise) {
        narrativeOutput.textContent = narrative;
        conciseOutput.textContent = concise;
        jsonOutput.textContent = JSON.stringify(payload, null, 2);
        summaryTable.innerHTML = buildSummaryRows(payload);
        resultsContainer.classList.remove('hidden');
        resultsEmpty.classList.add('hidden');
        copyNarrative.disabled = false;
        copyConcise.disabled = false;
      }

      function buildSummaryRows(payload) {
        const rows = [];
        rows.push(`<tr><th>Message type</th><td>${payload.message_type}</td></tr>`);
        if (payload.message_type !== 'camt.053') {
          const actors = payload.actors || {};
          rows.push(`<tr><th>Payer</th><td>${actorName(actors.debtor || actors.debtor_agent)}</td></tr>`);
          rows.push(`<tr><th>Beneficiary</th><td>${actorName(actors.creditor)}</td></tr>`);
          rows.push(`<tr><th>Amount</th><td>${formatAmount(payload.financial && payload.financial.settlement_amount)}</td></tr>`);
          const refs = payload.references || {};
          rows.push(`<tr><th>Instruction ID</th><td>${refs.instruction || 'n/a'}</td></tr>`);
          rows.push(`<tr><th>UETR</th><td>${refs.uetr || 'n/a'}</td></tr>`);
        } else {
          rows.push(`<tr><th>Account</th><td>${payload.account && payload.account.iban}</td></tr>`);
          rows.push(`<tr><th>Owner</th><td>${actorName(payload.account && payload.account.owner)}</td></tr>`);
          rows.push(`<tr><th>Closing balance</th><td>${payload.closing_balance ? `${payload.closing_balance.amount} ${payload.closing_balance.currency || ''}` : 'n/a'}</td></tr>`);
        }
        return rows.join('');
      }
    </script>
  </body>
</html>
