<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Smart XML Anonymizer</title>

    <!-- Tailwind CDN with custom brand color -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                500: '#5b8aff',
                600: '#3f6bff',
                700: '#1f4fff',
              },
            },
            boxShadow: {
              'brand-glow': '0 20px 80px rgba(91,138,255,0.25)',
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-slate-950 text-slate-100 min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-8 space-y-6">
      <header class="space-y-2">
        <p class="text-sm text-slate-500 uppercase tracking-[0.2em]">ISO 20022 Micro-tools</p>
        <h1 class="text-3xl font-semibold">Smart XML Anonymizer (“The Scrubber”)</h1>
        <p class="text-slate-400 max-w-3xl">
          Paste or upload ISO 20022 messages (pacs.008/009, camt.053, etc.) and get a vendor-safe version that preserves
          schema fidelity while masking PII. Works entirely locally—no data leaves your browser.
        </p>
      </header>

      <section class="grid md:grid-cols-2 gap-6">
        <div class="bg-slate-900 border border-slate-800 shadow-2xl rounded-2xl p-5 space-y-4">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-lg font-semibold">Input payment XML</h2>
              <p class="text-slate-500 text-sm">Paste, upload, or fetch from core.</p>
            </div>
          </div>

          <textarea
            id="inputXml"
            class="w-full h-72 resize-none font-mono text-sm leading-tight bg-slate-900/70 text-slate-100 rounded-xl border border-slate-800 p-3 focus:ring-2 focus:ring-brand-500 focus:outline-none"
            placeholder="Paste ISO 20022 XML here..."
          ></textarea>

          <div class="space-y-3">
            <label class="block text-slate-400 text-sm">Load sample:</label>
              <select
                id="sampleSelect"
                class="w-full bg-slate-950/80 border border-slate-800 rounded-xl p-3 text-slate-100 focus:ring-2 focus:ring-brand-500 focus:outline-none"
              >
                <option value="">Select sample...</option>
                <optgroup label="Validated CBPR+ (SR2025)">
                  <option value="./samples/pacs008-sample.xml">pacs.008 – Sample (CBPR+)</option>
                  <option value="./samples/pacs009-sample.xml">pacs.009 – Sample (CBPR+)</option>
                  <option value="./samples/bulk-pacs002-reject.md07.xml">pacs.002 – Reject MD07</option>
                  <option value="./samples/bulk-pacs004-return.xml">pacs.004 – Return</option>
                  <option value="./samples/bulk-pacs008-asia-urgent.xml">pacs.008 – Asia urgent</option>
                  <option value="./samples/bulk-pacs008-eur-cover.xml">pacs.008 – EUR cover</option>
                  <option value="./samples/bulk-pacs008-fx-multicurrency.xml">pacs.008 – FX multicurrency</option>
                  <option value="./samples/bulk-pacs008-gbp-priority.xml">pacs.008 – GBP priority</option>
                  <option value="./samples/bulk-pacs008-latam-trade.xml">pacs.008 – LATAM trade</option>
                  <option value="./samples/bulk-pacs008-sme-payroll.xml">pacs.008 – SME payroll</option>
                  <option value="./samples/bulk-pacs008-weekend.xml">pacs.008 – Weekend</option>
                  <option value="./samples/bulk-pacs009-africa-hvl.xml">pacs.009 – Africa HVL</option>
                  <option value="./samples/bulk-pacs009-asia-multi-hop.xml">pacs.009 – Asia multi-hop</option>
                  <option value="./samples/bulk-pacs009-cover-chf.xml">pacs.009 – CHF cover</option>
                  <option value="./samples/bulk-pacs009-serial-usd.xml">pacs.009 – Serial USD</option>
                  <option value="./samples/bulk-pacs009-weekend.xml">pacs.009 – Weekend</option>
                  <option value="./samples/bulk-camt052-intraday.xml">camt.052 – Intraday</option>
                  <option value="./samples/bulk-camt053-asia-multi-entry.xml">camt.053 – Asia multi-entry</option>
                  <option value="./samples/bulk-camt053-eur-weekend.xml">camt.053 – EUR weekend</option>
                  <option value="./samples/bulk-camt053-latam.xml">camt.053 – LATAM</option>
                  <option value="./samples/bulk-camt053-us-multicurrency.xml">camt.053 – US multicurrency</option>
                  <option value="./samples/bulk-camt054-credit.xml">camt.054 – Credit advice</option>
                </optgroup>
                <option value="./samples/sample-pacs008.xml">pacs.008 – Landing Page c.105.1.1</option>
                <option value="./samples/sample-pacs008-swiftref.xml">pacs.008 – Banco di Caribe → Harmony Bank (SWIFTRef)</option>
                <option value="./samples/sample-pacs008-usa-cover.xml">pacs.008 – USA cover payment</option>
                <option value="./samples/sample-pacs008-apac-multicurrency.xml">pacs.008 – APAC multi-currency</option>
                <option value="./samples/sample-pacs008-eu-structured-remit.xml">pacs.008 – EU structured remittance</option>
                <option value="./samples/sample-pacs008-intermediaries.xml">pacs.008 – With intermediaries</option>
                <option value="./samples/sample-pacs008-partial-actors.xml">pacs.008 – Partial actor info</option>

                <option value="./samples/sample-pacs009-swiftref.xml">pacs.009 – Punjab National → Indian Bank (SWIFTRef)</option>
                <option value="./samples/sample-pacs009-asia-timezone.xml">pacs.009 – Asia timezone</option>
                <option value="./samples/sample-pacs009-eu-cover.xml">pacs.009 – EU cover</option>
                <option value="./samples/sample-pacs009-eur-multi-hop.xml">pacs.009 – EUR multi-hop</option>
                <option value="./samples/sample-pacs009-highvalue-usd.xml">pacs.009 – High value USD</option>

                <option value="./samples/sample-pacs002-reject-ac03.xml">pacs.002 – Reject AC03 (account closed)</option>
                <option value="./samples/sample-pacs002-reject-be04.xml">pacs.002 – Reject BE04 (missing info)</option>
                <option value="./samples/sample-pacs002-reject-rc01.xml">pacs.002 – Reject RC01 (currency)</option>

                <option value="./samples/sample-pacs004-return-fee.xml">pacs.004 – Return with fees</option>

                <option value="./samples/sample-camt053-swiftref.xml">camt.053 – BNP Paribas Statement (SWIFTRef)</option>
                <option value="./samples/sample-camt053-multi-entry.xml">camt.053 – Multi-entry</option>
                <option value="./samples/sample-camt053-nostro-dualcurrency.xml">camt.053 – Nostro dual currency</option>
                <option value="./samples/sample-camt053-weekend-timezone.xml">camt.053 – Weekend/timezone</option>

                <option value="./samples/sample-camt052-intraday.xml">camt.052 – Intraday</option>
                <option value="./samples/sample-camt054-credit-advice.xml">camt.054 – Credit advice</option>
                <option value="./samples/sample-camt105-charges-notice.xml">camt.105 – Charges notice</option>
                <option value="./samples/sample-camt106-charges-request.xml">camt.106 – Charges request</option>
              </select>

            <input
              id="fileInput"
              type="file"
              accept=".xml,text/xml"
              class="w-full text-sm text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-brand-600 file:text-white file:cursor-pointer file:hover:bg-brand-700"
            />

            <div class="grid md:grid-cols-2 gap-3">
              <label class="flex items-center gap-2 text-slate-400 text-sm">
                <input type="checkbox" id="consistencyToggle" checked class="accent-brand-500" />
                Consistency mode (same values → same pseudonym)
              </label>
              <label class="flex items-center gap-2 text-slate-400 text-sm">
                <input type="checkbox" id="remittanceToggle" class="accent-brand-500" />
                Preserve remittance text (Ustrd)
              </label>
              <label class="flex items-center gap-2 text-slate-400 text-sm">
                <input type="checkbox" id="shiftToggle" class="accent-brand-500" />
                Shift timestamps
                <input
                  type="number"
                  id="shiftDays"
                  value="0"
                  class="ml-2 w-20 bg-slate-950/80 border border-slate-800 rounded-lg px-2 py-1 text-slate-100 focus:ring-2 focus:ring-brand-500 focus:outline-none"
                  disabled
                />
                days
              </label>
            </div>

            <div class="bg-slate-950/60 border border-slate-800 rounded-xl p-4 space-y-2">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="text-slate-200 font-semibold text-sm">Fetch from core banking API</h3>
                  <p class="text-slate-500 text-xs">Client-side only; nothing is stored.</p>
                </div>
                <button
                  id="toggleCorePanel"
                  class="text-xs px-3 py-2 rounded-lg border border-slate-700 text-slate-200 hover:bg-slate-800 transition"
                  type="button"
                  aria-expanded="false"
                >
                  Show
                </button>
              </div>
              <div id="coreApiPanel" class="space-y-2 hidden">
                <label class="block text-slate-400 text-sm space-y-1">
                  API base URL
                  <input
                    type="url"
                    id="coreBaseUrl"
                    placeholder="https://core.example.com/api"
                    class="w-full bg-slate-950/80 border border-slate-800 rounded-lg px-3 py-2 text-slate-100 focus:ring-2 focus:ring-brand-500 focus:outline-none"
                  />
                </label>
                <label class="block text-slate-400 text-sm space-y-1">
                  Message path template (use {id})
                  <input
                    type="text"
                    id="corePathTemplate"
                    value="/messages/{id}"
                    class="w-full bg-slate-950/80 border border-slate-800 rounded-lg px-3 py-2 text-slate-100 focus:ring-2 focus:ring-brand-500 focus:outline-none"
                  />
                </label>
                <label class="block text-slate-400 text-sm space-y-1">
                  Message ID
                  <input
                    type="text"
                    id="coreMessageId"
                    placeholder="e.g. pacs-12345"
                    class="w-full bg-slate-950/80 border border-slate-800 rounded-lg px-3 py-2 text-slate-100 focus:ring-2 focus:ring-brand-500 focus:outline-none"
                  />
                </label>
                <label class="block text-slate-400 text-sm space-y-1">
                  API key (optional, Bearer)
                  <input
                    type="password"
                    id="coreApiKey"
                    autocomplete="off"
                    class="w-full bg-slate-950/80 border border-slate-800 rounded-lg px-3 py-2 text-slate-100 focus:ring-2 focus:ring-brand-500 focus:outline-none"
                  />
                </label>
                <div class="flex items-center gap-3">
                  <button
                    class="btn btn-secondary bg-slate-800 border border-slate-700 text-slate-100 px-4 py-2 rounded-lg hover:bg-slate-700 transition-all"
                    id="fetchFromCore"
                  >
                    Fetch ISO message
                  </button>
                  <span id="coreApiStatus" class="text-slate-400 text-sm hidden"></span>
                </div>
              </div>
            </div>

            <button
              class="btn btn-primary w-full bg-brand-600 hover:bg-brand-700 text-white font-semibold py-3 rounded-xl shadow-brand-glow transition-all hover:scale-105"
              id="scrubButton"
            >
              Scrub XML
            </button>
            <div id="inputError" class="hidden bg-red-900/50 border border-red-700 text-red-200 text-sm rounded-lg p-3"></div>
          </div>
        </div>

        <div class="bg-slate-900 border border-slate-800 shadow-2xl rounded-2xl p-5 space-y-4">
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div>
              <h2 class="text-lg font-semibold">Results</h2>
              <p class="text-slate-500 text-sm">Review anonymized XML, diffs, and mapping.</p>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-secondary bg-slate-800 text-slate-100 px-3 py-2 rounded-lg" id="copyButton" disabled>
                Copy XML
              </button>
              <button class="btn btn-secondary bg-slate-800 text-slate-100 px-3 py-2 rounded-lg" id="downloadButton" disabled>
                Download XML
              </button>
            </div>
          </div>

          <div id="loader" class="hidden mx-auto border-4 border-slate-800 border-t-brand-500 rounded-full w-10 h-10 animate-spin"></div>
          <div id="resultsEmpty" class="text-slate-500 text-sm">Run the scrubber to visualize results.</div>

          <div id="resultsContainer" class="hidden space-y-4">
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2" id="statsContainer"></div>

            <div class="flex gap-2">
              <button class="tab-button active bg-slate-800 text-slate-100 px-3 py-2 rounded-lg" data-tab="output">
                Anonymized XML
              </button>
              <button class="tab-button bg-slate-800 text-slate-100 px-3 py-2 rounded-lg" data-tab="diff">Diff</button>
              <button class="tab-button bg-slate-800 text-slate-100 px-3 py-2 rounded-lg" data-tab="mapping">Mapping</button>
            </div>

            <div id="tab-output">
              <textarea
                id="outputXml"
                readonly
                class="w-full h-72 resize-none font-mono text-sm leading-tight bg-slate-900/70 text-slate-100 rounded-xl border border-slate-800 p-3 focus:ring-2 focus:ring-brand-500 focus:outline-none"
              ></textarea>
            </div>

            <div id="tab-diff" class="hidden">
              <div id="diffContainer" class="max-h-80 overflow-auto space-y-1"></div>
            </div>

            <div id="tab-mapping" class="hidden">
              <div class="max-h-80 overflow-auto">
                <table class="w-full text-sm text-slate-200">
                  <thead class="text-slate-500">
                    <tr>
                      <th class="py-2 text-left">#</th>
                      <th class="py-2 text-left">Type</th>
                      <th class="py-2 text-left">Original</th>
                      <th class="py-2 text-left">Pseudonym</th>
                      <th class="py-2 text-left">Tag</th>
                    </tr>
                  </thead>
                  <tbody id="mappingTable" class="divide-y divide-slate-800"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <script>
      const sampleSelect = document.getElementById('sampleSelect');
      const fileInput = document.getElementById('fileInput');
      const inputXml = document.getElementById('inputXml');
      const scrubButton = document.getElementById('scrubButton');
      const outputXml = document.getElementById('outputXml');
      const copyButton = document.getElementById('copyButton');
      const downloadButton = document.getElementById('downloadButton');
      const statsContainer = document.getElementById('statsContainer');
      const mappingTable = document.getElementById('mappingTable');
      const diffContainer = document.getElementById('diffContainer');
      const resultsContainer = document.getElementById('resultsContainer');
      const resultsEmpty = document.getElementById('resultsEmpty');
      const inputError = document.getElementById('inputError');
      const loader = document.getElementById('loader');
      const consistencyToggle = document.getElementById('consistencyToggle');
      const remittanceToggle = document.getElementById('remittanceToggle');
      const shiftToggle = document.getElementById('shiftToggle');
      const shiftDays = document.getElementById('shiftDays');
      const coreBaseUrl = document.getElementById('coreBaseUrl');
      const corePathTemplate = document.getElementById('corePathTemplate');
      const coreMessageId = document.getElementById('coreMessageId');
      const coreApiKey = document.getElementById('coreApiKey');
      const fetchFromCoreButton = document.getElementById('fetchFromCore');
      const coreApiStatus = document.getElementById('coreApiStatus');
      const toggleCorePanel = document.getElementById('toggleCorePanel');
      const coreApiPanel = document.getElementById('coreApiPanel');

      const tabButtons = Array.from(document.querySelectorAll('.tab-button'));
      const tabs = {
        output: document.getElementById('tab-output'),
        diff: document.getElementById('tab-diff'),
        mapping: document.getElementById('tab-mapping'),
      };

      const coreBankingApi = (() => {
        let config = {
          baseUrl: '',
          apiKey: '',
          pathTemplate: '/messages/{id}',
        };

        const normalizeBaseUrl = (value) => value.replace(/\/+$/, '');

        function setConfig({ baseUrl, apiKey, pathTemplate }) {
          config.baseUrl = baseUrl ? normalizeBaseUrl(baseUrl) : '';
          config.apiKey = apiKey ?? '';
          config.pathTemplate = pathTemplate && pathTemplate.trim() ? pathTemplate.trim() : '/messages/{id}';
        }

        function buildUrl(messageId) {
          const template = config.pathTemplate.includes('{id}')
            ? config.pathTemplate
            : `${config.pathTemplate.replace(/\/+$/, '')}/{id}`;
          const relative = template.startsWith('/') ? template : `/${template}`;
          return `${config.baseUrl}${relative.replace('{id}', encodeURIComponent(messageId))}`;
        }

        async function fetchMessage(messageId) {
          if (!config.baseUrl) throw new Error('API base URL is required.');
          if (!messageId) throw new Error('Message ID is required.');
          const url = buildUrl(messageId);
          const headers = {
            Accept: 'application/xml, text/xml, application/json;q=0.9, */*;q=0.8',
          };
          if (config.apiKey) headers.Authorization = `Bearer ${config.apiKey}`;
          const response = await fetch(url, { headers });
          if (!response.ok) {
            const body = await response.text().catch(() => '');
            const detail = body ? ` – ${body.slice(0, 140)}` : '';
            throw new Error(`HTTP ${response.status} ${response.statusText}${detail}`);
          }
          const contentType = response.headers.get('content-type') ?? '';
          if (contentType.includes('json')) {
            const data = await response.json();
            const xml = data?.xml ?? data?.message ?? data?.payload ?? data?.data;
            if (!xml || typeof xml !== 'string') {
              throw new Error('Response JSON missing XML payload (expected "xml" or "message").');
            }
            return xml;
          }
          return response.text();
        }

        return { setConfig, fetchMessage };
      })();

      window.coreBankingApi = coreBankingApi;

      function setCoreStatus(message, type = 'info') {
        coreApiStatus.textContent = message;
        coreApiStatus.classList.remove('hidden');
        coreApiStatus.style.color = type === 'error' ? '#fca5a5' : '#e5e7eb';
      }

      tabButtons.forEach((button) => {
        button.addEventListener('click', () => {
          tabButtons.forEach((btn) => btn.classList.remove('active', 'bg-slate-700'));
          button.classList.add('active', 'bg-slate-700');
          Object.values(tabs).forEach((tab) => tab.classList.add('hidden'));
          const target = button.dataset.tab;
          tabs[target].classList.remove('hidden');
        });
      });

      shiftToggle.addEventListener('change', () => {
        shiftDays.disabled = !shiftToggle.checked;
      });

      toggleCorePanel.addEventListener('click', () => {
        const isHidden = coreApiPanel.classList.contains('hidden');
        coreApiPanel.classList.toggle('hidden', !isHidden);
        toggleCorePanel.textContent = isHidden ? 'Hide' : 'Show';
        toggleCorePanel.setAttribute('aria-expanded', String(isHidden));
      });

      fetchFromCoreButton.addEventListener('click', async () => {
        fetchFromCoreButton.disabled = true;
        setCoreStatus('Fetching ISO message from core…', 'info');
        coreBankingApi.setConfig({
          baseUrl: coreBaseUrl.value.trim(),
          apiKey: coreApiKey.value.trim(),
          pathTemplate: corePathTemplate.value.trim(),
        });
        try {
          const xml = await coreBankingApi.fetchMessage(coreMessageId.value.trim());
          inputXml.value = xml;
          inputError.classList.add('hidden');
          setCoreStatus('Loaded message from core.', 'info');
        } catch (err) {
          console.error(err);
          setCoreStatus(err.message || 'Failed to fetch ISO message.', 'error');
        } finally {
          fetchFromCoreButton.disabled = false;
        }
      });

      sampleSelect.addEventListener('change', async (event) => {
        const path = event.target.value;
        if (!path) return;
        try {
          loader.classList.remove('hidden');
          const response = await fetch(path);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          const text = await response.text();
          inputXml.value = text;
          inputError.classList.add('hidden');
        } catch (err) {
          inputError.textContent = 'Unable to load sample file.';
          inputError.classList.remove('hidden');
        } finally {
          loader.classList.add('hidden');
        }
      });

      fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          inputXml.value = reader.result;
          inputError.classList.add('hidden');
        };
        reader.readAsText(file);
      });

      function generatePlaceholder(counter, type) {
        if (type === 'name') return `Person ${String.fromCharCode(64 + counter)}`;
        if (type === 'address') return `123 Harmony Street, City ${counter}, ZZ 9999`;
        if (type === 'iban') {
          const country = 'DE';
          const body = `${counter + 11}`.padStart(20, '0');
          const raw = `${body}${(country.charCodeAt(0) - 55).toString()}${(country.charCodeAt(1) - 55).toString()}00`;
          let remainder = 0n;
          for (const ch of raw) {
            remainder = (remainder * 10n + BigInt(ch)) % 97n;
          }
          const checkDigits = String(98n - remainder).padStart(2, '0');
          return `${country}${checkDigits}${body}`;
        }
        if (type === 'account') {
          return `0000${(counter * 7919).toString().padStart(12, '0')}`.slice(-12);
        }
        if (type === 'reference') {
          return `REF-${counter.toString().padStart(6, '0')}`;
        }
        return `Value-${counter}`;
      }

      function shiftIsoDate(value, offsetDays) {
        if (!offsetDays) return value;
        const match = value.match(/(\d{4}-\d{2}-\d{2})(T\d{2}:\d{2}:\d{2}(?:\.\d+)?(?:Z|[+\-]\d{2}:?\d{2})?)?/);
        if (!match) return value;
        const date = new Date(match[1]);
        if (Number.isNaN(date.getTime())) return value;
        date.setUTCDate(date.getUTCDate() + offsetDays);
        const isoDate = date.toISOString().slice(0, match[1].length);
        const timePart = match[2] ?? '';
        return value.replace(match[0], `${isoDate}${timePart}`);
      }

      function scrubXml(input, options) {
        let xml = input;
        const mapping = [];
        const stats = {
          name: 0,
          address: 0,
          iban: 0,
          account: 0,
          reference: 0,
          date: 0,
        };
        const cache = new Map();

        const register = (type, original, replacement, tag) => {
          if (original === replacement) return;
          mapping.push({ type, original: original.trim(), replacement, tag });
          stats[type] += 1;
        };

        const placeholderFor = (type, original) => {
          if (options.consistency) {
            const key = `${type}::${original}`;
            if (cache.has(key)) return cache.get(key);
            const placeholder = generatePlaceholder(stats[type] + 1, type);
            cache.set(key, placeholder);
            return placeholder;
          }
          return generatePlaceholder(stats[type] + 1, type);
        };

        xml = xml.replace(/<Nm>([\s\S]*?)<\/Nm>/gi, (match, value) => {
          const trimmed = value.trim();
          if (!trimmed || trimmed.length < 3 || /BIC/i.test(trimmed)) return match;
          const replacement = placeholderFor('name', trimmed);
          register('name', trimmed, replacement, 'Nm');
          return match.replace(value, replacement);
        });

        xml = xml.replace(/<PstlAdr>([\s\S]*?)<\/PstlAdr>/gi, (match, value) => {
          const trimmed = value.trim();
          if (!trimmed) return match;
          const replacement = placeholderFor('address', trimmed);
          register('address', trimmed, replacement, 'PstlAdr');
          return `<PstlAdr><StrtNm>${replacement}</StrtNm><TwnNm>Sample City</TwnNm><Ctry>ZZ</Ctry><PstCd>99999</PstCd></PstlAdr>`;
        });

        xml = xml.replace(/<IBAN>(.*?)<\/IBAN>/gi, (match, value) => {
          const trimmed = value.trim();
          if (!trimmed) return match;
          const replacement = placeholderFor('iban', trimmed);
          register('iban', trimmed, replacement, 'IBAN');
          return `<IBAN>${replacement}</IBAN>`;
        });

        xml = xml.replace(/<AcctId>([\s\S]*?)<\/AcctId>/gi, (match, inner) => {
          const updated = inner.replace(/<Id>(.*?)<\/Id>/gi, (m, value) => {
            const trimmed = value.trim();
            if (!trimmed || trimmed.length < 6) return m;
            const replacement = placeholderFor('account', trimmed);
            register('account', trimmed, replacement, 'AcctId.Id');
            return `<Id>${replacement}</Id>`;
          });
          return `<AcctId>${updated}</AcctId>`;
        });

        const referenceTags = ['EndToEndId', 'InstrId', 'TxId', 'UETR'];
        for (const tag of referenceTags) {
          const regex = new RegExp(`<${tag}>([\\s\\S]*?)<\\/${tag}>`, 'gi');
          xml = xml.replace(regex, (match, value) => {
            const trimmed = value.trim();
            if (!trimmed) return match;
            const replacement = placeholderFor('reference', trimmed);
            register('reference', trimmed, replacement, tag);
            return `<${tag}>${replacement}</${tag}>`;
          });
        }

        if (!options.preserveRemittance) {
          xml = xml.replace(/<Ustrd>([\s\S]*?)<\/Ustrd>/gi, (match, value) => {
            const trimmed = value.trim();
            if (!trimmed) return match;
            const replacement = placeholderFor('reference', trimmed);
            register('reference', trimmed, replacement, 'Ustrd');
            return `<Ustrd>${replacement}</Ustrd>`;
          });
        }

        if (options.shiftDates && options.dateOffset) {
          xml = xml.replace(
            /(\d{4}-\d{2}-\d{2}(?:T\d{2}:\d{2}:\d{2}(?:\.\d+)?(?:Z|[+\-]\d{2}:?\d{2})?)?)/g,
            (match) => {
              if (!/\d{4}-\d{2}-\d{2}/.test(match)) return match;
              const replacement = shiftIsoDate(match, options.dateOffset);
              if (replacement !== match) {
                register('date', match, replacement, 'Timestamp');
              }
              return replacement;
            },
          );
        }

        return { output: xml, mapping, stats };
      }

      function computeDiff(original, anonymized) {
        const origLines = original.split('\n');
        const anonLines = anonymized.split('\n');
        const max = Math.max(origLines.length, anonLines.length);
        const diff = [];
        for (let i = 0; i < max; i += 1) {
          const o = origLines[i] ?? '';
          const a = anonLines[i] ?? '';
          if (o === a) {
            diff.push({ type: 'same', value: a });
          } else {
            if (o) diff.push({ type: 'remove', value: `- ${o}` });
            if (a) diff.push({ type: 'add', value: `+ ${a}` });
          }
        }
        return diff;
      }

      function renderStats(stats) {
        statsContainer.innerHTML = '';
        const labels = {
          name: 'Names',
          address: 'Addresses',
          iban: 'IBANs',
          account: 'Accounts',
          reference: 'References',
          date: 'Timestamps',
        };
        Object.entries(stats).forEach(([key, value]) => {
          const card = document.createElement('div');
          card.className = 'bg-slate-950/80 border border-slate-800 rounded-xl p-3 text-center';
          card.innerHTML = `<div class="text-xs uppercase tracking-wide text-slate-500">${labels[key] ?? key}</div><div class="text-xl font-semibold text-slate-100">${value}</div>`;
          statsContainer.appendChild(card);
        });
      }

      function renderMapping(mapping) {
        mappingTable.innerHTML = '';
        mapping.forEach((item, idx) => {
          const row = document.createElement('tr');
          row.className = 'hover:bg-slate-800/60';
          row.innerHTML = `
            <td class="py-2">${idx + 1}</td>
            <td class="py-2">${item.type}</td>
            <td class="py-2"><pre class="whitespace-pre-wrap font-mono text-slate-200">${item.original}</pre></td>
            <td class="py-2"><pre class="whitespace-pre-wrap font-mono text-slate-200">${item.replacement}</pre></td>
            <td class="py-2">${item.tag}</td>
          `;
          mappingTable.appendChild(row);
        });
      }

      function renderDiff(diff) {
        diffContainer.innerHTML = '';
        diff.forEach((part) => {
          const div = document.createElement('div');
          div.className = 'font-mono text-sm whitespace-pre-wrap';
          if (part.type === 'add') div.classList.add('text-emerald-400');
          if (part.type === 'remove') div.classList.add('text-rose-400');
          div.textContent = part.value;
          diffContainer.appendChild(div);
        });
      }

      async function handleScrub() {
        const xml = inputXml.value.trim();
        if (!xml) {
          inputError.textContent = 'Please paste or upload XML to scrub.';
          inputError.classList.remove('hidden');
          return;
        }
        inputError.classList.add('hidden');
        loader.classList.remove('hidden');
        resultsEmpty.classList.add('hidden');
        resultsContainer.classList.add('hidden');
        try {
          const result = scrubXml(xml, {
            consistency: consistencyToggle.checked,
            preserveRemittance: remittanceToggle.checked,
            shiftDates: shiftToggle.checked,
            dateOffset: shiftToggle.checked ? Number(shiftDays.value) || 0 : 0,
          });
          outputXml.value = result.output;
          renderStats(result.stats);
          renderMapping(
            result.mapping.map((entry) => ({
              ...entry,
              type: entry.type,
            })),
          );
          renderDiff(computeDiff(xml, result.output));
          copyButton.disabled = false;
          downloadButton.disabled = false;
          resultsContainer.classList.remove('hidden');
        } catch (err) {
          console.error(err);
          inputError.textContent = 'Failed to process XML. Ensure the content is valid ISO 20022.';
          inputError.classList.remove('hidden');
        } finally {
          loader.classList.add('hidden');
        }
      }

      scrubButton.addEventListener('click', handleScrub);

      copyButton.addEventListener('click', async () => {
        if (!outputXml.value) return;
        await navigator.clipboard.writeText(outputXml.value);
        copyButton.textContent = 'Copied!';
        setTimeout(() => {
          copyButton.textContent = 'Copy XML';
        }, 1500);
      });

      downloadButton.addEventListener('click', () => {
        if (!outputXml.value) return;
        const blob = new Blob([outputXml.value], { type: 'text/xml' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'anonymized.xml';
        link.click();
        URL.revokeObjectURL(url);
      });
    </script>
  </body>
</html>
